<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Quransah Verification Assistant</title>
    
    <link href="css/style.css" rel="stylesheet">
    <link href="lib/tipuesearch/tipuesearch.css" rel="stylesheet">
        
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
</head>

<body style="padding: 20px;">
    <form action="">
        <input type="text" name="q" id="tipue_search_input" autocomplete="off">
    </form>
    <div id="tipue_search_content"></div>
    
    <script>
        var keys = [
            'AIzaSyDQ9H9ZrvKONfmJRHZZb-vWoqcbWFbMR00',
            'AIzaSyCkGrfuoX9Je30Ie0jRSKVVr2YEpFHa6f0',
            'AIzaSyBDIEw78uMLhZ2XfF7QCtpFPEPOl6aqQpI',
            'AIzaSyDUViYxm8Vv-qCypLPWmsOJPEZx0WfAAxQ',
            'AIzaSyA1WmDR_M_2WzcMt6GGqx9yEQ0AbrGDow8'
        ];
        var pin = 0;
        
        if(getURLP('q')) {
            $('#tipue_search_input').val(getURLP('q'));
            search($('#tipue_search_input').val())
        }
        
        function getURLP(name) {
            return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20')) || null;
        }
    
        function search(query) {
            //query = query
            //    .replace(/[\u0617-\u061A\u064B-\u0652\u06e1-\u06e9]/g, "")   //remove Tashkeel
            //    .replace(/[\u0671-\u0675\u0622\u0623\u0625]/g, "\u0627")      //strip symboled alif
            //    .replace(/\(\d+\)/g, " ")                                                                               //remove ayaNumber
            //;
            
            query = query.replace(/ /g, ' OR ');
            console.log("Search for "+query);

            $.ajax({
                type: 	"GET",
                dataType: "json",
                url:
                    "https://www.googleapis.com/customsearch/v1"+
                    "?key="+keys[pin]+"&"+
                    "&cx=007014468248327134923:_qpm0lcr_vu"+
                    "&num=10&start=1"+
                    "&q="+query,
                success: function(msg){
                    var item = '';
                    console.log(msg);
                    //console.log(msg.items);
                    for(var i in msg.items) {
                        //var temp = msg.items[i].link.replace(/.*?\/sura.*?(\d+).*?(\d+).*/g,'$1-$2').split('-');
                        //item += '<div class="item rtl">'+msg.items[i].htmlSnippet+'<div class="desc">Sura '+temp[0]+', Aya '+temp[1]+'</div></div>';
                        item += '<div class="tipue_search_content_title">'+msg.items[i].htmlTitle+'</div>';
                        item += '<div class="tipue_search_content_url">'+msg.items[i].link+'</div>';
                        item += '<div class="tipue_search_content_text">'+msg.items[i].htmlSnippet+'</div>';
                    }
                    $('#tipue_search_content').html(item);
                },
                error: function(err) {
                    //console.log(err.status + ': ' + err.responseJSON.error.message);
                    if(err.status=='403') {
                        pin++;
                        console.log('Trying '+pin);
                        search(query);
                    }
                }
            });
        }
    </script>
</body>
</html>