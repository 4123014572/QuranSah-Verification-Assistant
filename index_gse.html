<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Quransah Verification Assistant</title>
    <link href="css/style.css" rel="stylesheet">
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js'></script>
</head>

<body>
    <input type="text" class="rtl" onchange="search(this.value)" placeholder="enter quran aya..." value="بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ">
    <div class="result"></div>
    <script>
        var keys = [
            'AIzaSyDQ9H9ZrvKONfmJRHZZb-vWoqcbWFbMR00',
            'AIzaSyCkGrfuoX9Je30Ie0jRSKVVr2YEpFHa6f0',
            'AIzaSyBDIEw78uMLhZ2XfF7QCtpFPEPOl6aqQpI',
            'AIzaSyDUViYxm8Vv-qCypLPWmsOJPEZx0WfAAxQ',
            'AIzaSyA1WmDR_M_2WzcMt6GGqx9yEQ0AbrGDow8'
        ];
        var pin = 0;
        
        $('input.rtl').change();

        function search(query) {
            query = query
                .replace(/[\u0617-\u061A\u064B-\u0652\u06e1-\u06e9]/g, "")   //remove Tashkeel
                .replace(/[\u0671-\u0675\u0622\u0623\u0625]/g, "\u0627")      //strip symboled alif
                .replace(/\(\d+\)/g, " ")                                                                               //remove ayaNumber
            ;
            
            console.log("Search for "+query);
            
            $.ajax({
                type: 	"GET",
                dataType: "json",
                url:
                    "https://www.googleapis.com/customsearch/v1"+
                    "?key="+keys[pin]+"&"+
                    "&cx=007014468248327134923:pkmnhyz-eyu"+
                    "&num=10&start=1"+
                    "&q="+query,
                success: function(msg){
                    var fetched = [];
                    var item = '';
                    console.log(msg.items);
                    for(var i in msg.items) {
                        var temp = msg.items[i].link.replace(/.*?\/sura.*?(\d+).*?(\d+).*/g,'$1-$2').split('-');
                        if(fetched.indexOf(temp)<0) {
                            fetched.push(temp);
                            item += '<div class="item rtl">'+msg.items[i].htmlSnippet+'<div class="desc">Sura '+temp[0]+', Aya '+temp[1]+'</div></div>';
                        }
                    }
                    $('.result').html(item);
                },
                error: function(err) {
                    //console.log(err.status + ': ' + err.responseJSON.error.message);
                    if(err.status=='403') {
                        pin++;
                        console.log('Trying '+pin);
                        search(query);
                    }
                }
            });
        }        
    </script>
</body>
</html>